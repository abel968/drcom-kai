#include "package.h"

// challenge
unsigned char str1[20] = 
{
  0x01, 0x02, 0xff, 0xff, 0x09,// 2, 3
  0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00
};
// mkpkt
unsigned char str2[] = 
{
  0x03, 0x01, 0x00, 0xff,// 3
  // md5sum
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  // username [36]
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  // CONTROLCHECKSTATUS
  // ADAPTERNUM
  0x20, 0x03,
  // mac xor md51
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  // md5sum
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  // number of ip
  0x01,
  // ip address 1
  0x00, 0x00, 0x00, 0x00,
  // ip address 2
  0x00, 0x00, 0x00, 0x00,
  // ip address 3
  0x00, 0x00, 0x00, 0x00,
  // ip address 4
  0x00, 0x00, 0x00, 0x00,
  // md5sum md5
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  // IPDOG
  0x01,
  // delimeter
  0x00, 0x00, 0x00, 0x00,
  // hostname [32]
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  // primary DNS
  0x00, 0x00, 0x00, 0x00,
  // DHCP server
  0x00, 0x00, 0x00, 0x00,
  // secondary DNS
  0x00, 0x00, 0x00, 0x00,
  // delimeter
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  // unknown
  0x94, 0x00, 0x00, 0x00,
  // os major
  0x06, 0x00, 0x00, 0x00,
  // os minor
  0x02, 0x00, 0x00, 0x00,
  // os build
  0xf0, 0x23, 0x00, 0x00,
  // os unknown
  0x02, 0x00, 0x00, 0x00,
  0x44, 0x72, 0x43, 0x4f, 0x4d, 0x00, 0xcf, 0x07, 0x68,
  // unknown string [55]
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  // [40]
  0x33, 0x64, 0x63, 0x37, 0x39,
  0x66, 0x35, 0x32, 0x31, 0x32,
  0x65, 0x38, 0x31, 0x37, 0x30,
  0x61, 0x63, 0x66, 0x61, 0x39,
  0x65, 0x63, 0x39, 0x35, 0x66,
  0x31, 0x64, 0x37, 0x34, 0x39,
  0x31, 0x36, 0x35, 0x34, 0x32,
  0x62, 0x65, 0x37, 0x62, 0x31,
  // [24]
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  // AUTH_VERSION
  0x68, 0x00,
  // password length
  0x00, 0xff,
  // ror md5 & password
  0x00,
  0x02, 0x0c,
  // checksum
  0x00, 0x00, 0x00, 0x00,
  // delimeter
  0x00, 0x00,
  // mac
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  // strange 8-16 byte
  // 0, 2, 3
  0x00, 0x00, 0x00,
  // unknown random
  0x60, 0xa2,
  // [28]
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// keep-alive1
unsigned char str3[] = 
{
  0xff,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // md5
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,// tail
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, // time
  0x00, 0x00, 0x00, 0x00
};
// keep_alive_package_builder
unsigned char str4[] =
{
  0x07,
  0x00, //number
  0x28, 0x00, 0x0b,
  0x00, //type
  0x0f, 0x27, // first or KEEP_ALIVE_VERSION
  0x2f, 0x12, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00,// tail
  0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,// type 1 or type 3
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

unsigned char* Pack_str1(size_t* plen, int ran)
{
  str1[2] = (unsigned char)(ran & 0xff);
  str1[3] = (unsigned char)((ran >> 2) & 0xff);
  *plen = 20;
  return str1;
}

unsigned char* Pack_str2(size_t* plen, unsigned char* salt, char* host_ip, char* hostname, char* dns, char* username, char* password, unsigned char* mac)
{
  unsigned char* p_str2 = str2;
  
  p_str2 += 3;
  *p_str2 = (unsigned char)(strlen(username) + 20);
  
  p_str2++;
  unsigned char tmp1[] = {
    0x03, 0x01,
    0x00, 0x00, 0x00, 0x00, // salt
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 // password
  };
  size_t pwd_len = strlen(password);
  memcpy(tmp1 + 2, salt, 4);
  memcpy(tmp1 + 6, password, pwd_len);
  size_t tmp1_len = 6 + pwd_len;
  unsigned char md5_out[16];
  md5(tmp1, tmp1_len, md5_out); 
  memcpy(p_str2, md5_out, 16);
  p_str2 += 16;

  memcpy(p_str2, username, strlen(username));
  p_str2 += 38;

  unsigned char tmp2[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00
  };
  for (int i = 0; i < 6; i++)
  {
    tmp2[i] = str2[4 + i] ^ mac[i];
  }
  memcpy(p_str2, tmp2, 6);
  p_str2 += 6;

  unsigned char tmp3[] = {
    0x01,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // password
    0x00, 0x00, 0x00, 0x00, // salt
    0x00, 0x00, 0x00, 0x00
  };
  memcpy(tmp3 + 1, password, pwd_len);
  memcpy(tmp3 + 1 + pwd_len, salt, 4);
  size_t tmp3_len = 1 + pwd_len + 8;
  md5(tmp3, tmp3_len, md5_out);
  memcpy(p_str2, md5_out, 16);
  p_str2 += 16;
  p_str2++;

  unsigned char ip_tmp[4] = {
    0x00, 0x00, 0x00, 0x00
  };
  ipstr2byte(host_ip, ip_tmp);
  memcpy(p_str2, ip_tmp, 4);
  p_str2 += 16;

  unsigned char tmp4[] = {
    0x14, 0x00, 0x07, 0x0b
  };
  memcpy(p_str2, tmp4, 4);
  size_t pack_len = (size_t)(p_str2 + 4 - str2);
  md5(str2, pack_len, md5_out);
  memcpy(p_str2, md5_out, 8);
  p_str2 += 13;

  memcpy(p_str2, hostname, strlen(hostname));
  p_str2 += 32;

  ipstr2byte(dns, ip_tmp);
  memcpy(p_str2, ip_tmp, 4);
  p_str2 += 40;
  p_str2 += 55;
  p_str2 += 40;
  p_str2 += 24;
  p_str2 += 3;
  *p_str2++ = (unsigned char)pwd_len;

  unsigned char tmp5[] = {
    0x03, 0x01,
    0x00, 0x00, 0x00, 0x00, // salt
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 // password
  };
  size_t tmp5_len = 6 + pwd_len;
  md5(tmp5, tmp5_len, md5_out);
  *p_str2++ = ror(md5_out, password);
  p_str2 += 2;

  unsigned char tmp6[] = {
    0x01, 0x26, 0x07, 0x11
  };
  memcpy(p_str2, tmp6, 4);
  memcpy(p_str2 + 6, mac, 6);
  pack_len = (size_t)(p_str2 + 12 - str2);
  checksum(tmp6, str2, pack_len);
  memcpy(p_str2, tmp6, 4);
  p_str2 += 12;
  size_t strange_len = pwd_len / 4;
  if (strange_len == 4)
  {
    strange_len = 0;
  }
  p_str2 += strange_len;
  *p_str2++ = 0x60;
  *p_str2++ = 0xa2;
  p_str2 += 28;
  *plen = (size_t)(p_str2 - str2);
  return str2;
}

unsigned char* Pack_str3(size_t* plen, unsigned char* salt, unsigned char* tail, unsigned char* password)
{
  unsigned char tmp1[] = {
    0x03, 0x01,
    0x00, 0x00, 0x00, 0x00, // salt
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 // password
  };
  size_t pwd_len = strlen(password);
  memcpy(tmp1 + 2, salt, 4);
  memcpy(tmp1 + 6, password, pwd_len);
  size_t tmp1_len = 6 + pwd_len;
  unsigned char md5_out[16];
  md5(tmp1, tmp1_len, md5_out);
  memcpy(str3 + 1, md5_out, 16);
  memcpy(str3 + 20, tail, 16);

  unsigned int time = (unsigned int)GetTime();
  str3[36] = (unsigned char)((time >> 8) & 0xff);
  str3[37] = (unsigned char)(time & 0xff);
  *plen = 42;
  return str3;
}

unsigned char* Pack_str4(size_t* plen, char* host_ip, unsigned int* pnum, unsigned int* pran, unsigned char* tail, unsigned int type, unsigned int first)
{
  unsigned char* p_str = str4;
  p_str++;
  *p_str = (unsigned char)*pnum;
  p_str += 4;
  *p_str++ = (unsigned char)type;
  if (first)
  {
    *p_str++ = 0x0f;
    *p_str++ = 0x27;
  }
  else
  {
    *p_str++ = 0xdc;
    *p_str++ = 0x02;
  }
  p_str += 8;
  memcpy(p_str, tail, 4);
  p_str += 8;

  unsigned char ip_tmp[] = {0x00, 0x00, 0x00, 0x00};
  if (type == 3)
  {
    memset(p_str, 0, 4);
    p_str += 4;
    ipstr2byte(host_ip, ip_tmp);
    memcpy(p_str, ip_tmp, 4);
    p_str += 12;
  }
  else
  {
    memset(p_str, 0, 16);
    p_str += 16;
  }
  *plen = (size_t)(p_str - str4);
  return str4;
}